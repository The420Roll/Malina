import discord
from discord.ext import commands, tasks
from collections import defaultdict, deque
from datetime import datetime, timedelta

intents = discord.Intents.default()
intents.message_content = True
intents.messages = True

bot = commands.Bot(command_prefix="!", intents=intents)


# Settings
X = 100  # Threshold of messages in 10 minutes
CHECK_INTERVAL = 60  # Check every 60 seconds

# In Memory stores
message_log = defaultdict(lambda: deque())  # channel_id -> deque of timestamps
last_rodrigo_time = {}  # channel_id -> datetime of last "Woah, looks like there's a lot of comments right now. Y'all are probably looking for this https://ko-fi.com/rodrigoposting"


# Channels to ignore
ignored_channels = {"serious-discussion", "self-care"}


@bot.event
async def on_ready():
    print(f'Logged in as {bot.user.name}')
    check_channels.start()


@bot.event
async def on_message(message):
    if message.author.bot:
        return

    channel = message.channel
    if channel.name.lower() in ignored_channels:
        return

    now = datetime.utcnow()
    channel_id = channel.id

    # Add message timestamp
    msg_times = message_log[channel_id]
    msg_times.append(now)

    # Remove messages older than 10 minutes
    ten_minutes_ago = now - timedelta(minutes=10)
    while msg_times and msg_times[0] < ten_minutes_ago:
        msg_times.popleft()

    await bot.process_commands(message)


@tasks.loop(seconds=CHECK_INTERVAL)
async def check_channels():
    now = datetime.utcnow()
    for channel_id, timestamps in message_log.items():
        if len(timestamps) < X:
            continue

        last_time = last_rodrigo_time.get(channel_id)
        if last_time and now - last_time < timedelta(minutes=60):
            continue

        channel = bot.get_channel(channel_id)
        if channel and channel.name.lower() not in ignored_channels:
            await channel.send("Woah, looks like there's a lot of comments right now. Y'all are probably looking for this https://ko-fi.com/rodrigoposting")
            last_rodrigo_time[channel_id] = now
            print(f"Rodrigo message sent in channel {channel.name} at {now}")


bot.run("YOUR_TOKEN)
